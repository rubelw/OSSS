# =============================================================================
# Keycloak Realm Import / Bootstrap
# =============================================================================
AUTH_DEBUG=1                             # Enable auth-related debug logging
REALM=OSSS                               # Keycloak realm name
IMPORT_STRATEGY=OVERWRITE_EXISTING       # Strategy when importing realm config
RESET_REALM=0                            # 1 to reset realm on boot
KC_SKIP_ADMIN_ROLE_CHECK=1               # Skip KC admin role check during import

# Keycloak bootstrap admin (for logging into KC admin console)
KEYCLOAK_ADMIN=admin
KEYCLOAK_ADMIN_PASSWORD=admin

# =============================================================================
# Public (safe to expose to browser, e.g. frontend)
# =============================================================================
NEXT_PUBLIC_KEYCLOAK_BASE="http://localhost:8085"
NEXT_PUBLIC_KEYCLOAK_REALM=OSSS
NEXT_PUBLIC_KEYCLOAK_CLIENT_ID=osss-web
NEXT_PUBLIC_PUBLIC_URL="http://localhost:3000"
POST_LOGOUT_REDIRECT_URI="http://localhost:3000/"

# Callback for FastAPI app (OIDC redirect)
CALLBACK_URL="http://localhost:8081/callback"

# =============================================================================
# FastAPI Server (backend API)
# =============================================================================
# Core KC endpoints used by API (confidential client `osss-api`)
KEYCLOAK_SERVER_URL="http://localhost:8085"
KEYCLOAK_PUBLIC_URL="http://localhost:8085"
KEYCLOAK_BASE_URL="http://localhost:8085"
KEYCLOAK_REALM=OSSS
KEYCLOAK_CLIENT_ID=osss-api
KEYCLOAK_CLIENT_SECRET=password          # Secret for confidential client
KEYCLOAK_ALLOWED_AUDIENCES=osss-api,osss-web
KEYCLOAK_AUDIENCE=osss-api

# JWKS and OIDC
OIDC_ISSUER="http://localhost:8085/realms/OSSS"      # Issuer URL (no trailing slash)
OIDC_JWKS_URL="$OIDC_ISSUER/protocol/openid-connect/certs"
OIDC_CLIENT_ID="osss-api"                            # Client ID for validating aud
OIDC_VERIFY_AUD=0                                    # Disable audience verification (often needed with KC)

# JWT options (FastAPI fallback signing if HS256 used locally)
JWT_SECRET="super-dev-secret"
JWT_ALLOWED_ALGS="RS256,HS256"
JWKS_CACHE_SECONDS=600                # Cache JWKS keys for this many seconds
REQUIRE_AZP_MATCH=false               # If true, requires azp=client_id claim

# =============================================================================
# Database Config
# =============================================================================
# OSSS app DB
DATABASE_URL="postgresql+asyncpg://osss:password@localhost:5433/osss"
OSSS_DB_URL="postgresql+asyncpg://osss:password@localhost:5433/osss"
OSSS_DB_HOST="127.0.0.1"              # Or "osss_postgres" if running in Docker
OSSS_DB_PORT="5433"
OSSS_DB_NAME="osss"
OSSS_DB_USER="osss"
OSSS_DB_PASSWORD="password"

# Alembic (sync migrations)
ALEMBIC_DATABASE_URL="postgresql+psycopg2://osss:password@localhost:5433/osss"

# Keycloak internal DB (separate Postgres instance)
KC_DB=postgres
KC_DB_HOST=kc_postgres
KC_DB_PORT=5432
KC_DB_NAME=keycloak
KC_DB_USERNAME=keycloak
KC_DB_PASSWORD=password

# =============================================================================
# Keycloak Hostname Config
# =============================================================================
KC_HOSTNAME_URL="http://localhost:8085"
KC_HOSTNAME_ADMIN_URL="http://localhost:8085"
KC_HOSTNAME_STRICT="false"            # Allow fallback if mismatch with actual URL

# =============================================================================
# Redis / Sessions
# =============================================================================
REDIS_URL="redis://localhost:6379"
REDIS_VERSION="-7-alpine"

SESSION_SECRET="a-very-long-random-string-change-this-once"
SESSION_MAX_AGE="1209600"             # 14 days
SESSION_TTL_SECONDS=3600              # Default session TTL
ACCESS_TOKEN_REFRESH_SKEW_SECONDS=3600
COOKIE_DOMAIN="localhost"
COOKIE_SECURE="false"
COOKIE_SAMESITE="lax"

# =============================================================================
# Logging / Debug
# =============================================================================
OSSS_LOG_LEVEL="DEBUG"
OSSS_DEBUG_MAPPINGS=1
REQUESTS_DEBUG=1
PM_GEN_LOG_LEVEL=DEBUG
PM_GEN_LOG_ROWS=1
PM_GEN_LOG_INDEX=1
PM_GEN_SQL_ECHO=1
DV_LOG_LEVEL=DEBUG
DV_SQL_ECHO=1
USERS_LOG_LEVEL="DEBUG"
USERS_LOG_SQL="1"
TEST_LOG=1

# =============================================================================
# Swagger / API Docs
# =============================================================================
SWAGGER_CLIENT_ID="osss-api"
SWAGGER_CLIENT_SECRET="password"
APP_BASE_URL=http://localhost:8081/
OPENAPI_URL=http://localhost:8081/openapi.json

# =============================================================================
# Google Workspace Integration (optional)
# =============================================================================
OSSS_GOOGLE_CLIENT_ID=...
OSSS_GOOGLE_CLIENT_SECRET=...
OSSS_GOOGLE_OAUTH_REDIRECT_URI="https://your-host/api/google/callback"
OSSS_GOOGLE_PROJECT_ID=...
OSSS_GOOGLE_SA_JSON_PATH="/secrets/your-sa.json"
OSSS_GOOGLE_WORKSPACE_IMPERSONATE="admin@district.org"
OSSS_PUBSUB_VERIFICATION_TOKEN="something-random"
GC_SCOPES="https://www.googleapis.com/auth/classroom.courses https://www.googleapis.com/auth/classroom.rosters"

# =============================================================================
# Vault Integration
# =============================================================================
VAULT_OIDC_CLIENT_ID=vault
VAULT_OIDC_CLIENT_SECRET="password"    # Secret from Keycloak confidential client

VAULT_REDIRECT_BASE=https://localhost:8200
VAULT_DEV_ROOT_TOKEN_ID=root
VAULT_KV_PATH=secret/env
VAULT_OIDC_ROLE=keycloak

# Redirect URIs for Vault (CLI and UI)
VAULT_OIDC_CLI_REDIRECT=https://localhost:8250/oidc/callback
VAULT_OIDC_UI_REDIRECT=https://localhost:8200/ui/vault/auth/oidc/oidc/callback
VAULT_OIDC_REDIRECT="https://127.0.0.1:8200/ui/vault/auth/oidc/oidc/callback,https://127.0.0.1:8250/oidc/callback"

VAULT_OIDC_DISCOVERY_URL="http://localhost:8085/realms/OSSS"
VAULT_UI_REDIRECT=http://127.0.0.1:8200/ui/vault/auth/oidc/oidc/callback
VAULT_CLI_REDIRECT=https://127.0.0.1:8250/oidc/callback

VAULT_TOKEN=root

# =============================================================================
# TLS / Certificates
# =============================================================================
KC_CERT_HOSTS="keycloak,localhost,127.0.0.1"
ENABLE_LOCAL_TLS=1

# =============================================================================
# Misc / CORS
# =============================================================================
CORS_ORIGINS=
HAS_ASYNCPG="True"
INTEGRATION_AUTH=1
